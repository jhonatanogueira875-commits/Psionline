<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - PsicoConnect</title>
    <!-- Carrega o Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Cor de fundo suave */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body>

<!-- Configuração e Importações do Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variáveis Globais do Ambiente (Obrigatórias)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    setLogLevel('Debug');
    
    let app, db, auth;
    let userId = null;

    // Inicialização do Firebase
    if (Object.keys(firebaseConfig).length > 0) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Tenta autenticar
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Se não houver token, faz o login anônimo para obter um userId.
                        // Em um app real, aqui seria 'createUserWithEmailAndPassword'.
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação:", error);
                    showMessage('Erro na autenticação. Tente novamente.', 'error');
                }
            }

            // Listener de estado de autenticação
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('session-info').textContent = `Sessão ativa: ${userId}`;
                } else {
                    userId = null;
                    document.getElementById('session-info').textContent = 'Sessão não iniciada.';
                }
            });

            authenticate();

        } catch (e) {
            console.error("Erro ao inicializar o Firebase:", e);
            showMessage('Erro: Falha ao iniciar o aplicativo.', 'error');
        }
    } else {
        console.error("Configuração do Firebase vazia.");
        showMessage('Erro: Firebase não configurado.', 'error');
    }

    // --- FUNÇÕES DE LÓGICA DE CADASTRO ---

    /**
     * Função para exibir mensagens na caixa de status/erro.
     */
    function showMessage(message, type = 'info') {
        const box = document.getElementById('notification-box');
        box.textContent = message;
        box.className = 'absolute top-4 right-4 p-3 rounded-lg text-sm transition-opacity duration-300';
        
        if (type === 'error') {
            box.classList.add('bg-red-500', 'text-white');
        } else if (type === 'success') {
            box.classList.add('bg-green-500', 'text-white');
        } else {
            box.classList.add('bg-indigo-500', 'text-white');
        }
        
        box.classList.remove('hidden');
        setTimeout(() => {
            box.classList.add('hidden');
        }, 6000);
    }

    /**
     * Função principal de processamento do formulário de cadastro.
     */
    document.getElementById('register-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!userId) {
            showMessage("Aguarde a inicialização da sessão ou tente recarregar a página.", 'error');
            return;
        }

        const name = document.getElementById('user-name').value.trim();
        const email = document.getElementById('user-email').value.trim();
        const role = document.querySelector('input[name="user-role"]:checked')?.value;
        const btn = document.getElementById('register-btn');

        if (!name || !email || !role) {
            showMessage("Preencha todos os campos e selecione seu perfil.", 'error');
            return;
        }
        
        // Simulação de validação de e-mail/senha (não usada para auth real aqui, mas bom para a estrutura)
        // ...

        btn.textContent = 'Registrando...';
        btn.disabled = true;

        try {
            // 1. Salvar o perfil (role) na coleção de usuários pública
            // /artifacts/{appId}/public/data/users/{userId}
            const userDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', userId);
            
            const userData = {
                name: name,
                email: email,
                role: role, // 'psychologist' ou 'patient'
                createdAt: Date.now(),
                isSetupComplete: true,
                // Em um app real, o ID do psicólogo seria adicionado ao perfil do paciente aqui.
            };

            await setDoc(userDocRef, userData);

            showMessage(`Cadastro de ${name} como ${role === 'psychologist' ? 'Psicólogo(a)' : 'Paciente'} concluído!`, 'success');
            
            // 2. Redirecionamento (Simulado)
            setTimeout(() => {
                if (role === 'psychologist') {
                    // Simula ir para o dashboard do psicólogo
                    document.getElementById('redirect-message').innerHTML = '<p class="text-xl font-bold text-indigo-700 mt-4">Redirecionando para o Dashboard do Psicólogo...</p>';
                    // Na vida real, você faria window.location.href = 'dashboard_psicologo.html';
                    console.log("Simulando redirecionamento para o dashboard do Psicólogo.");
                } else {
                    // Simula ir para o dashboard do paciente
                    document.getElementById('redirect-message').innerHTML = '<p class="text-xl font-bold text-indigo-700 mt-4">Redirecionando para o Dashboard do Paciente...</p>';
                    // Na vida real, você faria window.location.href = 'dashboard_paciente.html';
                    console.log("Simulando redirecionamento para o dashboard do Paciente.");
                }
            }, 1000);


        } catch (error) {
            console.error("Erro ao registrar perfil:", error);
            showMessage(`Falha no cadastro: ${error.message}`, 'error');
        } finally {
            btn.textContent = 'Criar Minha Conta';
            btn.disabled = false;
        }
    });

</script>

<!-- Container Principal do Cadastro -->
<div class="w-full max-w-md bg-white p-8 sm:p-10 rounded-2xl shadow-2xl border border-gray-100">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-extrabold text-indigo-700">Psico<span class="text-gray-900">Connect</span></h1>
        <p class="text-gray-600 mt-2">Crie sua conta e comece sua jornada.</p>
    </div>

    <form id="register-form">
        <!-- Nome Completo -->
        <div class="mb-5">
            <label for="user-name" class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
            <input type="text" id="user-name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="Seu nome">
        </div>

        <!-- E-mail -->
        <div class="mb-5">
            <label for="user-email" class="block text-sm font-medium text-gray-700 mb-2">E-mail</label>
            <input type="email" id="user-email" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="seu@email.com">
        </div>

        <!-- Senha (Simulada, necessária para a UX) -->
        <div class="mb-6">
            <label for="user-password" class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
            <input type="password" id="user-password" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="********">
        </div>

        <!-- Seleção de Perfil (Role) -->
        <div class="mb-8">
            <p class="text-sm font-medium text-gray-700 mb-3">Qual é o seu perfil?</p>
            <div class="flex space-x-4">
                
                <!-- Opção Psicólogo -->
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="user-role" value="psychologist" required class="hidden peer">
                    <div class="p-4 border-2 border-gray-300 rounded-xl peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition duration-200 hover:shadow-md text-center">
                        <svg class="w-6 h-6 mx-auto text-indigo-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 2.21-2.91 4-6.5 4S-1 13.21-1 11c0-2.21 2.91-4 6.5-4s6.5 1.79 6.5 4zm0 0c0 2.21 2.91 4 6.5 4s6.5-1.79 6.5-4s-2.91-4-6.5-4s-6.5 1.79-6.5 4zM12 4v4m0 8v4m-4-4h8"></path></svg>
                        <span class="text-sm font-semibold text-gray-800">Psicólogo(a)</span>
                    </div>
                </label>

                <!-- Opção Paciente -->
                <label class="flex-1 cursor-pointer">
                    <input type="radio" name="user-role" value="patient" class="hidden peer">
                    <div class="p-4 border-2 border-gray-300 rounded-xl peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition duration-200 hover:shadow-md text-center">
                        <svg class="w-6 h-6 mx-auto text-indigo-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zm-7 7v2m2-4v4m2-4v4m0 0h-4M7 16a2 2 0 00-2 2v2h14v-2a2 2 0 00-2-2H7z"></path></svg>
                        <span class="text-sm font-semibold text-gray-800">Paciente</span>
                    </div>
                </label>
            </div>
        </div>

        <!-- Botão de Cadastro -->
        <button type="submit" id="register-btn" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-300 shadow-lg shadow-indigo-500/50">
            Criar Minha Conta
        </button>
    </form>

    <div id="redirect-message" class="text-center mt-6">
        <p class="text-sm text-gray-500">Já tem uma conta? <a href="#" class="text-indigo-600 hover:underline font-medium">Entrar</a></p>
    </div>
</div>

<!-- Notificação de Status (Toast) -->
<div id="notification-box" class="hidden"></div>
<!-- Informação de Sessão (Debug) -->
<div id="session-info" class="absolute bottom-2 left-2 text-xs text-gray-400">Sessão não iniciada.</div>

</body>
</html>
