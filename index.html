<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mood Tracker Firebase</title>
    <!-- Aviso: O CDN do Tailwind (abaixo) √© √≥timo para desenvolvimento, mas n√£o recomendado para produ√ß√£o, conforme o seu log. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo b√°sico para o corpo da aplica√ß√£o */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
        }
    </style>
</head>
<body>

<div id="app" class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 md:p-10">
    <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">Registro de Humor</h1>
    <p class="text-gray-500 mb-6">Demonstra√ß√£o de conex√£o real com o Firestore.</p>

    <!-- Status de Conex√£o e Usu√°rio -->
    <div id="status-card" class="bg-gray-100 p-4 rounded-xl mb-6 shadow-inner">
        <p class="text-sm font-semibold text-gray-700 mb-2">Status da Aplica√ß√£o</p>
        <div id="auth-status" class="text-sm text-yellow-600">
            <span class="font-bold">Inicializando Firebase...</span>
        </div>
        <div id="user-info" class="text-xs text-gray-600 mt-1"></div>
    </div>

    <!-- Formul√°rio de Registro de Humor -->
    <div id="log-form" class="hidden">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Como voc√™ se sente?</h2>

        <div class="mb-4">
            <label for="mood-level" class="block text-sm font-medium text-gray-700 mb-2">N√≠vel de Humor (1 a 5):</label>
            <input type="range" id="mood-level" min="1" max="5" value="3" class="w-full h-2 bg-indigo-200 rounded-lg appearance-none cursor-pointer range-lg">
            <div class="flex justify-between text-xs text-gray-500 mt-1">
                <span>1 (Muito Ruim)</span>
                <span id="mood-value">3</span>
                <span>5 (Excelente)</span>
            </div>
        </div>

        <div class="mb-6">
            <label for="mood-notes" class="block text-sm font-medium text-gray-700 mb-2">Notas (Opcional):</label>
            <textarea id="mood-notes" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="O que aconteceu hoje?"></textarea>
        </div>

        <button id="log-button" onclick="logMood()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition duration-200 ease-in-out shadow-lg transform hover:scale-[1.01]">
            Registrar Humor
        </button>
    </div>

    <!-- Registros Anteriores -->
    <div class="mt-8">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Seus √öltimos Registros (Real-Time)</h2>
        <div id="mood-list" class="space-y-3">
            <p id="loading-moods" class="text-gray-500 text-sm italic">Aguardando a carga dos registros...</p>
        </div>
    </div>
</div>

<script type="module">
    // Importa√ß√µes obrigat√≥rias do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Vari√°veis globais (fornecidas pelo ambiente)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, db, auth;
    let currentUserId = null;
    let isAuthReady = false;

    // Refer√™ncias DOM
    const authStatusElement = document.getElementById('auth-status');
    const userInfoElement = document.getElementById('user-info');
    const logFormElement = document.getElementById('log-form');
    const moodLevelInput = document.getElementById('mood-level');
    const moodNotesInput = document.getElementById('mood-notes');
    const moodValueSpan = document.getElementById('mood-value');
    const moodListElement = document.getElementById('mood-list');
    const loadingMoodsElement = document.getElementById('loading-moods');

    // Atualiza o valor do range slider
    moodLevelInput.addEventListener('input', () => {
        moodValueSpan.textContent = moodLevelInput.value;
    });

    // Fun√ß√£o para inicializar o Firebase e autenticar o usu√°rio
    async function initFirebaseAndAuth() {
        if (!firebaseConfig) {
            authStatusElement.innerHTML = '<span class="font-bold text-red-600">ERRO: Configura√ß√£o do Firebase n√£o encontrada.</span> Modo de Simula√ß√£o Ativado.';
            console.error("Firebase Configura√ß√£o vazia. N√£o √© poss√≠vel conectar ao banco de dados.");
            return;
        }

        try {
            // Habilita logs detalhados (opcional, mas √∫til para debug)
            setLogLevel('Debug');

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Listener de estado de autentica√ß√£o
            onAuthStateChanged(auth, async (user) => {
                isAuthReady = true;

                if (user) {
                    currentUserId = user.uid;
                    authStatusElement.innerHTML = `<span class="font-bold text-green-600">CONECTADO</span> ao Firebase.`;
                    userInfoElement.innerHTML = `ID do Usu√°rio (UID): <span class="font-mono bg-gray-200 px-1 rounded">${currentUserId}</span>`;
                    logFormElement.classList.remove('hidden');
                    listenForMoods();
                } else {
                    // Tenta a autentica√ß√£o inicial fornecida pelo ambiente
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        authStatusElement.innerHTML = `<span class="font-bold text-green-600">Autenticado</span> com Token Customizado.`;
                    } else {
                        // Faz o login an√¥nimo como fallback, se o token n√£o estiver dispon√≠vel
                        await signInAnonymously(auth);
                        authStatusElement.innerHTML = `<span class="font-bold text-green-600">Autenticado</span> Anonimamente.`;
                    }
                }
            });

            // For√ßa a execu√ß√£o do onAuthStateChanged se j√° estiver logado
            if (!auth.currentUser) {
                authStatusElement.innerHTML = '<span class="font-bold text-yellow-600">Autenticando...</span>';
            }

        } catch (error) {
            authStatusElement.innerHTML = `<span class="font-bold text-red-600">Erro na Inicializa√ß√£o:</span> ${error.message}`;
            console.error("Erro ao inicializar Firebase:", error);
        }
    }

    // Fun√ß√£o para registrar um novo humor (escreve no Firestore)
    window.logMood = async function() {
        if (!db || !currentUserId) {
            console.error("Firestore n√£o est√° pronto ou usu√°rio n√£o est√° autenticado.");
            return;
        }

        const moodLevel = parseInt(moodLevelInput.value, 10);
        const moodNotes = moodNotesInput.value.trim();

        const moodData = {
            level: moodLevel,
            notes: moodNotes,
            timestamp: serverTimestamp(),
            // Adiciona o ID do usu√°rio para garantir a propriedade (embora a regra de seguran√ßa j√° garanta o path)
            userId: currentUserId 
        };

        const collectionPath = `artifacts/${appId}/users/${currentUserId}/mood_logs`;

        try {
            // Adiciona um novo documento √† cole√ß√£o privada do usu√°rio
            const docRef = await addDoc(collection(db, collectionPath), moodData);
            console.log("Humor registrado com ID:", docRef.id);

            // Feedback visual
            const logButton = document.getElementById('log-button');
            logButton.textContent = 'Humor Registrado!';
            logButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            logButton.classList.add('bg-green-600');
            
            // Limpa o formul√°rio e restaura o bot√£o
            moodNotesInput.value = '';
            moodLevelInput.value = 3;
            moodValueSpan.textContent = 3;
            setTimeout(() => {
                logButton.textContent = 'Registrar Humor';
                logButton.classList.remove('bg-green-600');
                logButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }, 1500);

        } catch (e) {
            console.error("Erro ao adicionar documento: ", e);
            alert("Falha ao registrar humor. Veja o console para detalhes."); // Usando alert aqui apenas como √∫ltimo recurso, idealmente seria um modal customizado.
        }
    }

    // Fun√ß√£o para ouvir registros de humor em tempo real (l√™ do Firestore)
    function listenForMoods() {
        if (!db || !currentUserId) {
            console.error("Firestore n√£o est√° pronto.");
            return;
        }

        const collectionPath = `artifacts/${appId}/users/${currentUserId}/mood_logs`;
        const moodsRef = collection(db, collectionPath);
        
        // A consulta √© apenas para a cole√ß√£o privada do usu√°rio
        const q = query(moodsRef); 

        // onSnapshot mant√©m a lista sincronizada em tempo real
        onSnapshot(q, (querySnapshot) => {
            const moods = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                moods.push({
                    id: doc.id,
                    ...data
                });
            });

            // Ordena os dados por timestamp (in-memory, para evitar a necessidade de √≠ndice no Firestore)
            moods.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            renderMoods(moods);
        }, (error) => {
            console.error("Erro ao ouvir registros de humor:", error);
            moodListElement.innerHTML = `<p class="text-red-500 text-sm italic">Erro ao carregar dados: ${error.message}</p>`;
        });
    }

    // Fun√ß√£o para renderizar a lista de humores
    function renderMoods(moods) {
        if (moods.length === 0) {
            moodListElement.innerHTML = `<p class="text-gray-500 text-sm italic">Nenhum registro de humor encontrado. Registre seu primeiro humor acima!</p>`;
            return;
        }

        // Mapeia o n√≠vel para uma cor/emoji
        const moodMap = {
            5: { label: 'Excelente', color: 'bg-green-100 text-green-700', icon: 'üòä' },
            4: { label: 'Bom', color: 'bg-blue-100 text-blue-700', icon: 'üôÇ' },
            3: { label: 'Neutro', color: 'bg-yellow-100 text-yellow-700', icon: 'üòê' },
            2: { label: 'Ruim', color: 'bg-orange-100 text-orange-700', icon: 'üòü' },
            1: { label: 'Muito Ruim', color: 'bg-red-100 text-red-700', icon: 'üò≠' },
        };

        moodListElement.innerHTML = moods.map(mood => {
            const map = moodMap[mood.level] || moodMap[3];
            const date = mood.timestamp ? new Date(mood.timestamp.seconds * 1000).toLocaleString('pt-BR') : 'Data Desconhecida';
            
            return `
                <div class="${map.color} p-4 rounded-xl border border-gray-200 flex items-start space-x-4">
                    <div class="text-3xl">${map.icon}</div>
                    <div class="flex-grow">
                        <p class="font-semibold text-base">${map.label} (N√≠vel ${mood.level})</p>
                        <p class="text-xs text-gray-500 mb-2">${date}</p>
                        ${mood.notes ? `<p class="text-sm italic text-gray-800 break-words">${mood.notes}</p>` : `<p class="text-sm italic text-gray-500">Sem notas adicionais.</p>`}
                    </div>
                </div>
            `;
        }).join('');
    }

    // Inicia a aplica√ß√£o
    window.onload = initFirebaseAndAuth;
</script>

</body>
</html>
