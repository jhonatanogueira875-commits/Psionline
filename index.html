<!--
  Painel de Administração para Aplicação Psi Online.
  Este arquivo inclui todo o HTML, CSS (Tailwind) e JavaScript/Supabase.
  Ele implementa:
  1. Login com verificação de Role (Admin) via RLS no Supabase.
  2. Carregamento condicional do dashboard se o usuário for 'admin'.
  3. Recuperação de dados de usuários e agendamentos em tempo real.
  4. Uso de Exponential Backoff nas chamadas da API do Supabase.
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Psi Online</title>
    <!-- Carregamento do Tailwind CSS para estilização -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Estilos de Botão Personalizados */
        .btn-primary {
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary:hover {
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center">

    <!-- Conteúdo Principal - Visível após o carregamento do DOM -->
    <div id="app" class="w-full max-w-7xl p-4 md:p-8" style="display:none;">

        <!-- Seção de Login (Inicialmente visível) -->
        <section id="login-section" class="flex flex-col items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-white p-8 rounded-xl card-shadow">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Acesso Administrativo</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email:</label>
                        <input type="email" id="email" name="email" required placeholder="admin@psionline.com"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value="jhonatanogueira875@gmail.com">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha:</label>
                        <input type="password" id="password" name="password" required placeholder="••••••••"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button type="submit" id="login-btn"
                        class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg btn-primary hover:bg-blue-700 disabled:bg-blue-400">
                        Entrar
                    </button>
                    <p id="login-message" class="text-center text-sm font-medium mt-4"></p>
                </form>
            </div>
        </section>

        <!-- Seção do Dashboard (Visível apenas para Admin) -->
        <section id="dashboard-section" class="hidden">
            <header class="flex justify-between items-center pb-6 border-b border-gray-200 mb-6">
                <h1 class="text-4xl font-bold text-gray-800">Dashboard Administrativo</h1>
                <button id="logout-btn"
                    class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">
                    Sair
                </button>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                <!-- Card 1: Total de Usuários -->
                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-blue-500">
                    <p class="text-sm font-medium text-gray-500">Total de Usuários</p>
                    <p id="user-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <!-- Card 2: Agendamentos Pendentes -->
                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-yellow-500">
                    <p class="text-sm font-medium text-gray-500">Agendamentos Pendentes</p>
                    <p id="pending-appointments" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
                <!-- Card 3: Psícologos Ativos -->
                <div class="bg-white p-6 rounded-xl card-shadow border-l-4 border-green-500">
                    <p class="text-sm font-medium text-gray-500">Psicólogos Ativos</p>
                    <p id="psychologist-count" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Tabela de Últimos Agendamentos -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Próximos Agendamentos</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data/Hora</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente (ID)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-list" class="bg-white divide-y divide-gray-200">
                                <!-- Dados de Agendamentos aqui -->
                                <tr><td colspan="3" class="px-3 py-4 text-sm text-gray-500 text-center">Carregando agendamentos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Tabela de Últimos Usuários Registrados -->
                <div class="bg-white p-6 rounded-xl card-shadow">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Usuários Recentes</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email (ID)</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Função</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                </tr>
                            </thead>
                            <tbody id="users-list" class="bg-white divide-y divide-gray-200">
                                <!-- Dados de Usuários aqui -->
                                <tr><td colspan="3" class="px-3 py-4 text-sm text-gray-500 text-center">Carregando usuários...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Modal de Mensagem (em vez de alert()) -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg max-w-sm w-full card-shadow">
                <h3 id="modal-title" class="text-lg font-bold mb-3 text-red-600">Erro</h3>
                <p id="modal-body" class="text-sm text-gray-700 mb-4">Mensagem de erro.</p>
                <div class="flex justify-end">
                    <button id="modal-close-btn" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">
                        Entendi
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts de Firebase/Supabase e Lógica da Aplicação -->
    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.3/+esm";

        // Variáveis globais obrigatórias no ambiente Canvas (simulação local)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        // O Supabase não usa o firebaseConfig, mas é mantido por convenção.

        // Configurações e Inicialização do Supabase
        const SUPABASE_URL = firebaseConfig.projectId ? `https://${firebaseConfig.projectId}.supabase.co` : 'SUA_URL_SUPABASE_AQUI';
        const SUPABASE_ANON_KEY = firebaseConfig.apiKey || 'SUA_CHAVE_ANON_AQUI';

        // Verificação de URL e Chave para evitar erros de inicialização.
        if (SUPABASE_URL.includes('SUA_URL_SUPABASE_AQUI') || SUPABASE_ANON_KEY.includes('SUA_CHAVE_ANON_AQUI')) {
            console.error("ATENÇÃO: As credenciais do Supabase não foram configuradas. Verifique se __firebase_config foi injetado corretamente.");
            // Usar valores de exemplo para evitar que o código quebre, mas o login falhará.
            // Aqui, usamos um cliente fictício, mas o login real precisa das credenciais.
            window.supabaseClient = null; 
        } else {
            window.supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        }

        // Referências DOM
        const loginSection = document.getElementById('login-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const loginForm = document.getElementById('login-form');
        const loginBtn = document.getElementById('login-btn');
        const loginMessage = document.getElementById('login-message');
        const logoutBtn = document.getElementById('logout-btn');
        const appointmentsList = document.getElementById('appointments-list');
        const usersList = document.getElementById('users-list');
        const userCountElement = document.getElementById('user-count');
        const pendingAppointmentsElement = document.getElementById('pending-appointments');
        const psychologistCountElement = document.getElementById('psychologist-count');
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        // --- Funções de Utilidade (Modal e RLS) ---

        /**
         * Exibe um modal personalizado em vez de alert().
         * @param {string} title Título do modal.
         * @param {string} message Corpo da mensagem.
         */
        const showCustomModal = (title, message, isError = true) => {
            modalTitle.textContent = title;
            modalBody.textContent = message;
            modalTitle.className = isError ? 'text-lg font-bold mb-3 text-red-600' : 'text-lg font-bold mb-3 text-green-600';
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        modalCloseBtn.onclick = () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        };


        /**
         * Executa uma função com lógica de Exponential Backoff para retentar em caso de falha temporária.
         * @param {Function} apiCall Função que retorna a Promise da chamada de API.
         * @param {number} maxRetries Número máximo de retentativas.
         * @returns {Promise<any>} O resultado da chamada de API bem-sucedida.
         */
        async function runWithBackoff(apiCall, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const result = await apiCall();
                    if (result.error && result.error.status && [406, 500].includes(result.error.status)) {
                        // Tratar RLS (406) ou erro de servidor como falha, mas tentar novamente
                        throw new Error(result.error.message || 'Erro temporário do servidor/RLS');
                    }
                    return result; // Retorna em sucesso
                } catch (error) {
                    // Se for a última tentativa, falhar.
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    // Calcular o tempo de espera: 2^i * 1000ms
                    const delay = Math.pow(2, i) * 1000;
                    // console.log(`Tentativa ${i + 1} falhou. Retentando em ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- Funções de Autenticação e Autorização ---

        /**
         * Verifica o papel (role) do usuário no banco de dados.
         * REQUER RLS: A política de RLS 1 na tabela 'users' é crucial aqui.
         * @param {string} user_id O ID (auth.uid) do usuário logado.
         * @returns {Promise<string|null>} A função do usuário ('admin', 'psychologist', 'client') ou null.
         */
        async function checkAdminRole(user_id) {
            if (!supabaseClient) return null;

            try {
                // Tenta buscar APENAS a role do usuário.
                // A RLS Policy 1 (Allow authenticated to read own role) permite esta leitura.
                const { data, error } = await runWithBackoff(() => 
                    supabaseClient
                        .from('users')
                        .select('role') 
                        .eq('id', user_id)
                        .single()
                );

                if (error) {
                    console.error("Erro ao buscar função do usuário:", error);
                    return null;
                }
                
                return data ? data.role : null;

            } catch (error) {
                console.error("Erro ao buscar função do usuário (final após backoff):", error);
                return null;
            }
        }


        /**
         * Lida com o processo de login, verificando credenciais e a função do usuário.
         */
        async function handleLogin(event) {
            event.preventDefault();
            
            if (!supabaseClient) {
                showCustomModal("Erro de Configuração", "O Supabase não foi inicializado. Verifique a configuração.");
                return;
            }

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'Verificando...';
            loginMessage.textContent = '';
            
            try {
                // 1. Tenta fazer login com as credenciais do Supabase Auth
                const { data: authData, error: authError } = await runWithBackoff(() => 
                    supabaseClient.auth.signInWithPassword({ email, password })
                );

                if (authError) {
                    // Erro 400 - Credenciais Inválidas
                    throw new Error(authError.message || 'Invalid login credentials');
                }
                
                const user = authData.user;
                const role = await checkAdminRole(user.id);
                
                if (role !== 'admin') {
                    // 2. Se a autenticação for OK, mas a função não for 'admin', deslogar e bloquear
                    await supabaseClient.auth.signOut();
                    throw new Error("Acesso negado. Apenas administradores podem acessar este painel.");
                }

                // Sucesso: Redirecionar para o dashboard
                loginSection.classList.add('hidden');
                dashboardSection.classList.remove('hidden');
                
                // Iniciar escutas do Dashboard
                setupDashboardListeners();

            } catch (error) {
                console.error("Erro de login/permissão:", error);
                const message = error.message.includes('Invalid login credentials') 
                    ? "Credenciais inválidas. Verifique seu e-mail e senha." 
                    : error.message;

                loginMessage.textContent = message;
                showCustomModal("Erro de Acesso", message);
                
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Entrar';
            }
        }

        /**
         * Lida com o processo de logout.
         */
        async function handleLogout() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            // Limpar a UI e mostrar a seção de login
            dashboardSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            location.reload(); // Recarrega para limpar listeners de onSnapshot
        }

        // --- Funções do Dashboard (Após o Login) ---

        let userListener = null;
        let appointmentListener = null;

        /**
         * Configura os listeners de real-time do Supabase.
         * Estes listeners são protegidos pelas Políticas de RLS 2 e 3.
         */
        function setupDashboardListeners() {
            if (!supabaseClient) return;

            // ----------------------------------------------------
            // Listener 1: Usuários
            // RLS Policy 2 (Allow admin to read all users) protege este listener.
            // ----------------------------------------------------
            if (userListener) userListener.unsubscribe(); // Evita duplicação

            const usersQuery = supabaseClient
                .from('users')
                .select('*')
                .order('created_at', { ascending: false });

            userListener = usersQuery.on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, (payload) => {
                fetchUsers();
            })
            .subscribe();

            fetchUsers(); // Chamada inicial

            // ----------------------------------------------------
            // Listener 2: Agendamentos
            // RLS Policy 3 (Allow admin access to appointments) protege este listener.
            // ----------------------------------------------------
            if (appointmentListener) appointmentListener.unsubscribe(); // Evita duplicação

            const appointmentsQuery = supabaseClient
                .from('appointments')
                .select('*')
                .order('appointment_date', { ascending: true });

            appointmentListener = appointmentsQuery.on('postgres_changes', { event: '*', schema: 'public', table: 'appointments' }, (payload) => {
                fetchAppointments();
            })
            .subscribe();

            fetchAppointments(); // Chamada inicial
        }

        // Função para buscar e renderizar a lista de usuários
        async function fetchUsers() {
            try {
                // RLS Policy 2 aplicada automaticamente aqui
                const { data: users, error } = await runWithBackoff(() => 
                    supabaseClient
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(5)
                );

                if (error) {
                    console.error("Erro ao carregar usuários:", error);
                    usersList.innerHTML = `<tr><td colspan="3" class="px-3 py-4 text-sm text-red-500 text-center">Erro RLS/Carregamento: ${error.message}</td></tr>`;
                    return;
                }

                userCountElement.textContent = users.length; // Contagem só do que foi buscado. (Idealmente seria uma RPC ou COUNT)
                const psychologistCount = users.filter(u => u.role === 'psychologist').length;
                psychologistCountElement.textContent = psychologistCount;

                if (users.length === 0) {
                    usersList.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-sm text-gray-500 text-center">Nenhum usuário encontrado.</td></tr>';
                    return;
                }

                usersList.innerHTML = users.map(user => `
                    <tr>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${user.email} (${user.id.substring(0, 4)}...)</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700 capitalize">${user.role}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${user.full_name || 'N/A'}</td>
                    </tr>
                `).join('');

            } catch (error) {
                 console.error("Falha ao buscar usuários (após backoff):", error);
                 usersList.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-sm text-red-500 text-center">Falha crítica ao carregar dados.</td></tr>';
            }
        }

        // Função para buscar e renderizar a lista de agendamentos
        async function fetchAppointments() {
            try {
                // RLS Policy 3 aplicada automaticamente aqui
                const { data: appointments, error } = await runWithBackoff(() => 
                    supabaseClient
                        .from('appointments')
                        .select('*')
                        .order('appointment_date', { ascending: true })
                        .limit(5)
                );

                if (error) {
                    console.error("Erro ao carregar agendamentos:", error);
                    appointmentsList.innerHTML = `<tr><td colspan="3" class="px-3 py-4 text-sm text-red-500 text-center">Erro RLS/Carregamento: ${error.message}</td></tr>`;
                    return;
                }

                const pendingCount = appointments.filter(a => a.status === 'pending').length;
                pendingAppointmentsElement.textContent = pendingCount;

                if (appointments.length === 0) {
                    appointmentsList.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-sm text-gray-500 text-center">Nenhum agendamento encontrado.</td></tr>';
                    return;
                }

                appointmentsList.innerHTML = appointments.map(appt => {
                    const date = new Date(appt.appointment_date);
                    const formattedDate = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                    const statusColor = appt.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';

                    return `
                        <tr>
                            <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">${formattedDate}</td>
                            <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-700">${appt.client_user_id.substring(0, 8)}...</td>
                            <td class="px-3 py-2 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor} capitalize">
                                    ${appt.status}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                 console.error("Falha ao buscar agendamentos (após backoff):", error);
                 appointmentsList.innerHTML = '<tr><td colspan="3" class="px-3 py-4 text-sm text-red-500 text-center">Falha crítica ao carregar dados.</td></tr>';
            }
        }


        // --- Inicialização e Event Listeners ---

        function initApp() {
            document.getElementById('app').style.display = 'block'; // Mostrar conteúdo após o DOM
            console.log("✔ DOM Carregado e app.js inicializado");

            if (!supabaseClient) {
                showCustomModal("Erro Crítico", "Supabase não inicializado. Verifique as variáveis de ambiente.", true);
                return;
            }

            // Listener de estado de autenticação (verifica se o usuário já está logado)
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session) {
                    const role = await checkAdminRole(session.user.id);
                    if (role === 'admin') {
                        loginSection.classList.add('hidden');
                        dashboardSection.classList.remove('hidden');
                        setupDashboardListeners();
                    } else {
                        // Se estiver logado, mas não for admin, desloga forçadamente
                        await supabaseClient.auth.signOut();
                        loginSection.classList.remove('hidden');
                        dashboardSection.classList.add('hidden');
                        showCustomModal("Acesso Negado", "Sua sessão foi encerrada. Apenas administradores podem acessar.", true);
                    }
                } else {
                    // Não está logado
                    loginSection.classList.remove('hidden');
                    dashboardSection.classList.add('hidden');
                }
            });

            // Event listener do formulário de login
            loginForm.addEventListener('submit', handleLogin);
            
            // Event listener do botão de logout
            logoutBtn.addEventListener('click', handleLogout);
        }

        // Inicializa a aplicação quando o DOM estiver pronto
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
