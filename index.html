<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PsiOnline - Plataforma de Telepsicologia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="https://js.stripe.com/v3/"></script>

</head>
<body>
    <div id="app"></div>

    <script>
        // CLIENTE SUPABASE (Mantido)
        const { createClient } = window.supabase;
        const supabaseClient = createClient(
            'https://jhcylgeukoiomydgppxc.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoY3lsZ2V1a29pb215ZGdwcHhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk3MzUsImV4cCI6MjA3OTE4NTczNX0.OGBU7RK2lwSZaS1xvxyngV8tgoi3M7o0kv_xCX0Ku5A'
        );

        // ESTADO GLOBAL (Mantido)
        let currentPage = 'home';
        let currentUser = null;
        let adminTab = 'dashboard';
        let patientTab = 'appointments';
        let psychologistTab = 'schedule';
        let selectedPsychologist = null;
        let selectedDate = null;
        let selectedTime = null;
        
        let dashboardData = {
            psychologists: [],
            patients: [],
            appointments: [],
            stats: { totalPsychologists: 0, totalPatients: 0, totalAppointments: 0, totalRevenue: 0 }
        };

        // FUN√á√ïES DE DADOS (Mantidas)
        async function loadDashboardData() {
            try {
                const { data: psyData } = await supabaseClient.from('psychologists').select('*, users(name, email, phone)');
                const { data: patData } = await supabaseClient.from('patients').select('*, users(name, email, created_at)');
                const { data: aptData } = await supabaseClient.from('appointments').select('*, patients(users(name)), psychologists(users(name))');

                dashboardData.psychologists = psyData || [];
                dashboardData.patients = patData || [];
                dashboardData.appointments = aptData || [];
                
                const totalRev = (aptData || []).reduce((sum, apt) => sum + parseFloat(apt.value || 0), 0);
                dashboardData.stats = {
                    totalPsychologists: psyData?.length || 0,
                    totalPatients: patData?.length || 0,
                    totalAppointments: aptData?.length || 0,
                    totalRevenue: totalRev
                };
            } catch (err) {
                console.error('Erro ao carregar dados:', err);
            }
        }

        async function loadPatientAppointments() {
            try {
                const { data: patientData } = await supabaseClient
                    .from('patients')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .single();

                if (patientData) {
                    const { data: appointments } = await supabaseClient
                        .from('appointments')
                        .select('*, psychologists(users(name), session_price)')
                        .eq('patient_id', patientData.id)
                        .order('scheduled_date', { ascending: true });
                    
                    return appointments || [];
                }
                return [];
            } catch (err) {
                console.error('Erro ao carregar consultas:', err);
                return [];
            }
        }

        async function loadPsychologistAppointments() {
            try {
                const { data: psychologistData } = await supabaseClient
                    .from('psychologists')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .single();

                if (psychologistData) {
                    const { data: appointments } = await supabaseClient
                        .from('appointments')
                        .select('*, patients(users(name))')
                        .eq('psychologist_id', psychologistData.id)
                        .order('scheduled_date', { ascending: true });
                    
                    return appointments || [];
                }
                return [];
            } catch (err) {
                console.error('Erro ao carregar consultas:', err);
                return [];
            }
        }

        function getNextDays(count = 7) {
            const days = [];
            const today = new Date();
            for (let i = 0; i < count; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                days.push({
                    date: date.toISOString().split('T')[0],
                    dayName: date.toLocaleDateString('pt-BR', { weekday: 'short' }),
                    dayNumber: date.getDate()
                });
            }
            return days;
        }

        function getAvailableTimes() {
            return ['09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00', '18:00'];
        }

        // FUN√á√ÉO bookAppointment: AGORA CHAMA O PAGAMENTO ANTES DE INSERIR
        async function bookAppointment(psychologistId, date, time) {
            try {
                // 1. (NO FUTURO: CHAMA EDGE FUNCTION PARA PROCESSAR PAGAMENTO)
                // Se o pagamento for bem-sucedido:

                const { data: patientData } = await supabaseClient
                    .from('patients')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .single();

                const { data: psychologistData } = await supabaseClient
                    .from('psychologists')
                    .select('session_price')
                    .eq('id', psychologistId)
                    .single();

                if (!patientData) {
                    alert('Erro: Dados do paciente n√£o encontrados');
                    return false;
                }

                const { error } = await supabaseClient
                    .from('appointments')
                    .insert({
                        patient_id: patientData.id,
                        psychologist_id: psychologistId,
                        scheduled_date: date,
                        scheduled_time: time,
                        value: psychologistData?.session_price || 150,
                        status: 'confirmed' // MUDAN√áA: AGORA CONFIRMADO, POIS PAGOU
                    });

                if (error) {
                    alert('Erro ao agendar consulta');
                    return false;
                }

                alert('‚úÖ Pagamento processado e consulta CONFIRMADA!');
                return true;
            } catch (err) {
                console.error('Erro:', err);
                alert('Erro ao agendar consulta');
                return false;
            }
        }

        async function updateAppointmentStatus(appointmentId, status) {
            try {
                const { error } = await supabaseClient
                    .from('appointments')
                    .update({ status })
                    .eq('id', appointmentId);

                if (!error) {
                    alert(status === 'confirmed' ? '‚úÖ Consulta confirmada!' : '‚ùå Consulta cancelada');
                    return true;
                }
                return false;
            } catch (err) {
                console.error('Erro:', err);
                return false;
            }
        }

        // FUN√á√ïES DE NAVEGA√á√ÉO
        function goToHome() { currentPage = 'home'; currentUser = null; render(); }
        function goToLogin(type) { currentPage = 'login-' + type; render(); }
        function goToBooking() { currentPage = 'book-appointment'; render(); }
        function backToPatientDashboard() { currentPage = 'dashboard-patient'; render(); }
        
        function selectPsychologist(id) { selectedPsychologist = id; selectedDate = null; selectedTime = null; render(); }
        function clearPsychologistSelection() { selectedPsychologist = null; selectedDate = null; selectedTime = null; render(); }
        function selectDate(date) { selectedDate = date; selectedTime = null; render(); }
        function selectTime(time) { selectedTime = time; render(); }

        // NOVIDADE: Transi√ß√£o para o Formul√°rio de Pagamento
        function goToPaymentForm() {
            currentPage = 'payment-form';
            render();
        }

        // FUN√á√ïES DE AUTENTICA√á√ÉO (Adicionei o corpo delas, que estava faltando)
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const userType = currentPage.split('-')[1];

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

                if (error) throw error;
                
                currentUser = { 
                    id: data.user.id, 
                    email: data.user.email,
                    // NOTE: Voc√™ precisar√° de uma fun√ß√£o para buscar o nome do usu√°rio na tabela 'users'
                    name: data.user.email.split('@')[0], 
                    role: userType // Armazena a role de login
                };

                await loadDashboardData(); // Carrega dados iniciais

                if (userType === 'admin' && currentUser.email === 'admin@psionline.com') {
                    currentPage = 'dashboard-admin';
                } else if (userType === 'psychologist') {
                    // TODO: Verificar se o usu√°rio existe na tabela 'psychologists'
                    currentPage = 'dashboard-psychologist';
                } else if (userType === 'patient') {
                    // TODO: Verificar se o usu√°rio existe na tabela 'patients'
                    currentPage = 'dashboard-patient';
                } else {
                    alert('Usu√°rio n√£o autorizado ou perfil n√£o encontrado.');
                    await supabaseClient.auth.signOut();
                    currentUser = null;
                    goToHome();
                    return;
                }

                render();
            } catch (err) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.querySelector('p').textContent = err.message || 'Erro de login. Verifique suas credenciais.';
                errorDiv.classList.remove('hidden');
                console.error(err);
            }
        }

        async function logout() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            goToHome();
        }

        // FUN√á√ÉO PRINCIPAL DE RENDERIZA√á√ÉO
        function render() {
            const app = document.getElementById('app');
            
            if (currentPage === 'home') {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
                        <div class="max-w-6xl w-full">
                            <div class="text-center mb-16">
                                <h1 class="text-6xl font-bold text-indigo-900 mb-4">PsiOnline</h1>
                                <p class="text-2xl text-gray-700 mb-2">Plataforma Completa de Telepsicologia</p>
                                <p class="text-green-600 font-semibold">‚úì Sistema de Pagamento em Integra√ß√£o</p>
                            </div>
                            
                            <div class="grid md:grid-cols-3 gap-8">
                                <div onclick="goToLogin('patient')" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:scale-105">
                                    <div class="text-center">
                                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold mb-3 text-gray-900">Sou Paciente</h2>
                                        <p class="text-gray-600">Agende consultas online</p>
                                    </div>
                                </div>

                                <div onclick="goToLogin('psychologist')" class="bg-white p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:scale-105">
                                    <div class="text-center">
                                        <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold mb-3 text-gray-900">Sou Psic√≥logo</h2>
                                        <p class="text-gray-600">Gerencie atendimentos</p>
                                    </div>
                                </div>

                                <div onclick="goToLogin('admin')" class="bg-gradient-to-br from-purple-600 to-indigo-700 p-8 rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 cursor-pointer transform hover:scale-105">
                                    <div class="text-center">
                                        <div class="w-20 h-20 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold mb-3 text-white">Administrador</h2>
                                        <p class="text-white">Controle da plataforma</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentPage.startsWith('login')) {
                renderLoginPage();
            } else if (currentPage === 'dashboard-admin') {
                // ... renderAdminDashboard();
                app.innerHTML = `<div class="p-8"><h1 class="text-4xl">Admin Dashboard (TODO)</h1><p>Bem-vindo, ${currentUser?.name}.</p><button onclick="logout()" class="bg-red-500 text-white p-2 rounded mt-4">Sair</button></div>`;
            } else if (currentPage === 'dashboard-psychologist') {
                // ... renderPsychologistDashboard();
                app.innerHTML = `<div class="p-8"><h1 class="text-4xl">Psic√≥logo Dashboard (TODO)</h1><p>Bem-vindo, ${currentUser?.name}.</p><button onclick="logout()" class="bg-red-500 text-white p-2 rounded mt-4">Sair</button></div>`;
            } else if (currentPage === 'dashboard-patient') {
                renderPatientDashboard();
            } else if (currentPage === 'book-appointment') {
                renderBookingPage();
            // NOVIDADE: Rota para o Formul√°rio de Pagamento
            } else if (currentPage === 'payment-form') { 
                renderPaymentForm();
            }
        }

        function renderLoginPage() {
            const app = document.getElementById('app');
            const userType = currentPage.split('-')[1];
            const title = userType === 'admin' ? 'Administrador' : userType === 'psychologist' ? 'Psic√≥logo' : 'Paciente';
            
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center px-4">
                    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full">
                        <button onclick="goToHome()" class="text-indigo-600 mb-6 hover:text-indigo-800 font-semibold flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                            Voltar
                        </button>
                        
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-900">√Årea do ${title}</h2>
                        </div>
                        
                        <div id="error-message" class="hidden mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                            <p class="text-red-600 text-sm font-semibold"></p>
                        </div>
                        
                        <div id="success-message" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                            <p class="text-green-600 text-sm font-semibold"></p>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Email</label>
                                <input id="email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="seu@email.com">
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 mb-2 font-semibold">Senha</label>
                                <input id="password" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            
                            <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">
                                Entrar
                            </button>
                            
                            <div class="mt-6 p-4 bg-blue-50 rounded-lg text-xs">
                                <p class="font-bold text-gray-800 mb-2">Contas de teste:</p>
                                <p class="text-gray-600">Admin: admin@psionline.com / admin123</p>
                                <p class="text-gray-600">Psic√≥logo: joao@email.com / senha123</p>
                                <p class="text-gray-600">Paciente: maria@email.com / senha123</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function renderPatientDashboard() {
            const app = document.getElementById('app');
            const appointments = await loadPatientAppointments();
            
            const upcoming = appointments.filter(a => new Date(a.scheduled_date) >= new Date() && a.status !== 'cancelled');
            const past = appointments.filter(a => new Date(a.scheduled_date) < new Date() || a.status === 'completed');

            let content = `
                <div>
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold">Minhas Consultas</h2>
                        <button onclick="goToBooking()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Agendar Nova Consulta
                        </button>
                    </div>

                    ${upcoming.length > 0 ? `
                        <div class="mb-8">
                            <h3 class="text-xl font-bold mb-4">Pr√≥ximas Consultas</h3>
                            <div class="space-y-4">
                                ${upcoming.map(apt => `
                                    <div class="bg-white p-6 rounded-xl shadow-md border-l-4 ${apt.status === 'confirmed' ? 'border-green-500' : 'border-yellow-500'}">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-bold text-lg text-gray-900">${apt.psychologists?.users?.name || 'Psic√≥logo'}</p>
                                                <p class="text-gray-600">üìÖ ${new Date(apt.scheduled_date).toLocaleDateString('pt-BR')} √†s ${apt.scheduled_time}</p>
                                                <p class="text-gray-600">üí∞ R$ ${apt.value}</p>
                                                <span class="inline-block mt-2 px-3 py-1 rounded-full text-xs font-semibold ${
                                                    apt.status === 'confirmed' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'
                                                }">
                                                    ${apt.status === 'confirmed' ? '‚úì Confirmada' : '‚è≥ Aguardando Confirma√ß√£o'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-8 text-center mb-8">
                            <svg class="w-16 h-16 text-blue-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <p class="text-blue-800 font-semibold mb-2">Nenhuma consulta agendada</p>
                            <p class="text-blue-600 text-sm">Clique em "Agendar Nova Consulta" para come√ßar</p>
                        </div>
                    `}

                    ${past.length > 0 ? `
                        <div>
                            <h3 class="text-xl font-bold mb-4">Hist√≥rico</h3>
                            <div class="space-y-3">
                                ${past.slice(0, 5).map(apt => `
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="font-semibold text-gray-900">${apt.psychologists?.users?.name || 'Psic√≥logo'}</p>
                                        <p class="text-sm text-gray-600">${new Date(apt.scheduled_date).toLocaleDateString('pt-BR')} - R$ ${apt.value}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            app.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-gradient-to-r from-blue-600 to-cyan-700 shadow-lg">
                        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
                            <h1 class="text-2xl font-bold text-white">PsiOnline - Paciente</h1>
                            <div class="flex items-center gap-4">
                                <span class="text-white text-sm">üë§ ${currentUser?.name}</span>
                                <button onclick="logout()" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                    Sair
                                </button>
                            </div>
                        </div>
                    </nav>

                    <div class="container mx-auto px-4 py-6">
                        ${content}
                    </div>
                </div>
            `;
        }

        async function renderBookingPage() {
            const app = document.getElementById('app');
            const days = getNextDays(7);
            const times = getAvailableTimes();

            if (!selectedPsychologist) {
                const { psychologists } = dashboardData;
                if (psychologists.length === 0) await loadDashboardData();

                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50">
                        <nav class="bg-gradient-to-r from-blue-600 to-cyan-700 shadow-lg">
                            <div class="container mx-auto px-4 py-4">
                                <button onclick="backToPatientDashboard()" class="text-white hover:text-gray-200 font-semibold flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                    </svg>
                                    Voltar
                                </button>
                            </div>
                        </nav>

                        <div class="container mx-auto px-4 py-8">
                            <h2 class="text-3xl font-bold mb-6">Escolha um Psic√≥logo</h2>
                            
                            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                ${dashboardData.psychologists.filter(p => p.status === 'approved').map(psy => `
                                    <div onclick="selectPsychologist('${psy.id}')" class="bg-white p-6 rounded-xl shadow-md hover:shadow-xl transition-all cursor-pointer transform hover:scale-105">
                                        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                        </div>
                                        <h3 class="font-bold text-lg text-center mb-2">${psy.users?.name || 'Psic√≥logo'}</h3>
                                        <p class="text-sm text-gray-600 text-center mb-2">CRP: ${psy.crp}</p>
                                        <p class="text-center text-indigo-600 font-bold text-lg">R$ ${psy.session_price || 150}/sess√£o</p>
                                        <p class="text-xs text-gray-500 text-center mt-2">${psy.total_patients || 0} pacientes</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            const selectedPsy = dashboardData.psychologists.find(p => p.id === selectedPsychologist);

            app.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-gradient-to-r from-blue-600 to-cyan-700 shadow-lg">
                        <div class="container mx-auto px-4 py-4">
                            <button onclick="clearPsychologistSelection()" class="text-white hover:text-gray-200 font-semibold flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                                </svg>
                                Escolher outro psic√≥logo
                            </button>
                        </div>
                    </nav>

                    <div class="container mx-auto px-4 py-8 max-w-4xl">
                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h2 class="text-2xl font-bold mb-2">${selectedPsy?.users?.name || 'Psic√≥logo'}</h2>
                            <p class="text-gray-600">CRP: ${selectedPsy?.crp}</p>
                            <p class="text-indigo-600 font-bold text-xl mt-2">R$ ${selectedPsy?.session_price || 150}/sess√£o</p>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                            <h3 class="text-xl font-bold mb-4">Escolha uma Data</h3>
                            <div class="grid grid-cols-7 gap-2">
                                ${days.map(day => `
                                    <button onclick="selectDate('${day.date}')" class="p-3 rounded-lg border-2 transition-all ${selectedDate === day.date ? 'border-indigo-600 bg-indigo-50' : 'border-gray-200 hover:border-indigo-300'}">
                                        <p class="text-xs text-gray-600 uppercase">${day.dayName}</p>
                                        <p class="text-lg font-bold">${day.dayNumber}</p>
                                    </button>
                                `).join('')}
                            </div>
                        </div>

                        ${selectedDate ? `
                            <div class="bg-white p-6 rounded-xl shadow-md mb-6">
                                <h3 class="text-xl font-bold mb-4">Escolha um Hor√°rio</h3>
                                <div class="grid grid-cols-4 gap-3">
                                    ${times.map(time => `
                                        <button onclick="selectTime('${time}')" class="p-3 rounded-lg border-2 font-semibold transition-all ${selectedTime === time ? 'border-indigo-600 bg-indigo-600 text-white' : 'border-gray-200 hover:border-indigo-300'}">
                                            ${time}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}

                        ${selectedDate && selectedTime ? `
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-xl shadow-lg text-white">
                                <h3 class="text-xl font-bold mb-4">Revisar e Pagar</h3>
                                <div class="space-y-2 mb-4">
                                    <p>üë®‚Äç‚öïÔ∏è Psic√≥logo: <span class="font-bold">${selectedPsy?.users?.name}</span></p>
                                    <p>üìÖ Data: <span class="font-bold">${new Date(selectedDate).toLocaleDateString('pt-BR')}</span></p>
                                    <p>‚è∞ Hor√°rio: <span class="font-bold">${selectedTime}</span></p>
                                    <p class="text-3xl mt-4">üí∞ Total: <span class="font-extrabold">R$ ${selectedPsy?.session_price || 150}</span></p>
                                </div>
                                <button onclick="goToPaymentForm()" class="w-full bg-white text-indigo-600 py-3 rounded-lg font-bold hover:bg-gray-100 transition-colors">
                                    Ir para o Pagamento Seguro
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // NOVIDADE: FUN√á√ÉO PARA RENDERIZAR O FORMUL√ÅRIO DE PAGAMENTO (Fron-end)
        async function renderPaymentForm() {
            const app = document.getElementById('app');
            const selectedPsy = dashboardData.psychologists.find(p => p.id === selectedPsychologist);
            const amount = selectedPsy?.session_price || 150;
            
            app.innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <nav class="bg-gradient-to-r from-blue-600 to-cyan-700 shadow-lg">
                        <div class="container mx-auto px-4 py-4">
                            <button onclick="currentPage = 'book-appointment'; render();" class="text-white hover:text-gray-200 font-semibold flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg> Voltar
                            </button>
                        </div>
                    </nav>

                    <div class="container mx-auto px-4 py-8 max-w-lg">
                        <div class="bg-white p-8 rounded-2xl shadow-xl">
                            <h2 class="text-3xl font-bold mb-4 text-gray-900">Finalizar Pagamento</h2>
                            <p class="text-gray-600 mb-6">Sess√£o com <span class="font-semibold">${selectedPsy?.users?.name}</span> em ${new Date(selectedDate).toLocaleDateString('pt-BR')} √†s ${selectedTime}</p>
                            
                            <div class="bg-indigo-50 p-4 rounded-lg mb-6">
                                <p class="text-3xl font-extrabold text-indigo-700">R$ ${amount.toFixed(2).replace('.', ',')}</p>
                                <p class="text-sm text-indigo-600">Cobrado imediatamente. Consulta confirmada ap√≥s sucesso.</p>
                            </div>

                            <form id="payment-form">
                                <div class="space-y-4 mb-4">
                                    <div>
                                        <label class="block text-gray-700 mb-1 font-semibold">Nome no Cart√£o</label>
                                        <input type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg" placeholder="Nome Sobrenome">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 mb-1 font-semibold">N√∫mero do Cart√£o (Simulado)</label>
                                        <div id="card-element" class="p-3 border border-gray-300 rounded-lg bg-gray-100 italic text-gray-500">
                                            Aguardando Elemento Card do Stripe... (Implementa√ß√£o no Edge Function)
                                        </div>
                                    </div>
                                </div>

                                <div id="card-errors" class="text-red-600 text-sm mb-4" role="alert"></div>

                                <button id="submit-button" type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                                    Pagar R$ ${amount.toFixed(2).replace('.', ',')} e Confirmar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            `;

            // NOVIDADE: Chama a fun√ß√£o para adicionar o evento de submit, simulando o pagamento
            initializeStripeForm(amount, selectedPsychologist, selectedDate, selectedTime);
        }

        // NOVIDADE: Fun√ß√£o para simular a l√≥gica do Stripe (chamando bookAppointment)
        async function initializeStripeForm(amount, psychologistId, date, time) {
            const form = document.getElementById('payment-form');

            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitButton = document.getElementById('submit-button');
                    submitButton.disabled = true;
                    submitButton.innerHTML = 'Processando...';

                    // Aqui, em uma aplica√ß√£o real, voc√™ faria:
                    // 1. Chamar uma Edge Function para criar o Payment Intent no Stripe.
                    // 2. Confirmar o Payment Intent usando o card element (tokeniza√ß√£o).

                    // Para demonstra√ß√£o, vamos simular o sucesso e agendar
                    setTimeout(async () => {
                        const success = await bookAppointment(psychologistId, date, time);
                        
                        if (success) {
                            currentPage = 'dashboard-patient';
                            render();
                        } else {
                            submitButton.disabled = false;
                            submitButton.innerHTML = `Pagar R$ ${amount.toFixed(2).replace('.', ',')} e Confirmar`;
                        }
                    }, 1500); // Simula um tempo de processamento de 1.5 segundos
                });
            }
        }


        // INICIA A APLICA√á√ÉO
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                // Tenta carregar o dashboard se j√° estiver logado
                // Por simplicidade, vamos para a home se o user j√° estiver na sess√£o, e o handleLogin vai redirecionar
                // Idealmente, a role seria carregada do DB/Metadados do user
                currentPage = 'home'; 
                
                // Se o usu√°rio est√° logado, tenta obter informa√ß√µes b√°sicas para evitar redirecionar
                currentUser = { 
                    id: session.user.id, 
                    email: session.user.email,
                    name: session.user.email.split('@')[0], 
                    role: 'unknown'
                };
            }
            // Chama o render inicial
            render();
        });
        
    </script>
</body>
</html>
