<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Psic√≥logo - PsicoConnect</title>
    <!-- Carrega o Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .mood-indicator {
            font-size: 1.5rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #eef2ff;
        }
        /* Estilo para notas longas, for√ßando quebras */
        .notes-content {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>

<!-- Configura√ß√£o e Importa√ß√µes do Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Vari√°veis Globais do Ambiente (Obrigat√≥rias)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    setLogLevel('Debug');
    
    let app, db, auth;
    let psychologistId = null;
    let isAuthReady = false;
    let selectedPatientId = null;
    let selectedPatientName = null;

    // Mapeamento de Humor para Emoji/Cor
    const MOOD_MAP = {
        1: { emoji: 'üò≠', color: 'bg-red-200 text-red-800', text: 'Terr√≠vel' },
        2: { emoji: 'üòî', color: 'bg-yellow-200 text-yellow-800', text: 'Ruim' },
        3: { emoji: 'üòê', color: 'bg-gray-200 text-gray-800', text: 'Neutro' },
        4: { emoji: 'üòä', color: 'bg-green-220 text-green-800', text: 'Bom' },
        5: { emoji: 'ü§©', color: 'bg-blue-200 text-blue-800', text: 'Excelente' },
    };

    // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---

    try {
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autentica√ß√£o:", error);
                    showMessage('Erro na autentica√ß√£o. Recarregue a p√°gina.', 'error');
                }
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    psychologistId = user.uid;
                    document.getElementById('psychologist-id').textContent = psychologistId;
                    isAuthReady = true;
                    // Inicia o carregamento da lista de pacientes
                    loadPatientList();
                } else {
                    psychologistId = null;
                    isAuthReady = true;
                    document.getElementById('psychologist-id').textContent = 'N√£o autenticado.';
                    showMessage('Voc√™ precisa estar logado como Psic√≥logo.', 'error');
                }
            });

            authenticate();

        } else {
            console.error("Configura√ß√£o do Firebase vazia.");
            showMessage('Erro: Firebase n√£o configurado.', 'error');
        }
    } catch (e) {
        console.error("Erro fatal ao inicializar o Firebase:", e);
        showMessage('Erro: Falha ao iniciar o aplicativo.', 'error');
    }

    // --- FUN√á√ïES DE UTILIDADE ---

    function showMessage(message, type = 'info') {
        const box = document.getElementById('notification-box');
        box.textContent = message;
        box.className = 'absolute top-4 right-4 p-3 rounded-lg text-sm transition-opacity duration-300 z-50';
        
        if (type === 'error') {
            box.classList.add('bg-red-500', 'text-white');
        } else if (type === 'success') {
            box.classList.add('bg-green-500', 'text-white');
        } else {
            box.classList.add('bg-indigo-500', 'text-white');
        }
        
        box.classList.remove('hidden');
        setTimeout(() => {
            box.classList.add('hidden');
        }, 5000);
    }

    function formatDate(timestamp) {
        if (!timestamp) return 'Data Indispon√≠vel';
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleDateString('pt-BR', options);
    }
    
    // --- L√ìGICA DE ASSOCIA√á√ÉO E LISTA DE PACIENTES ---

    document.getElementById('add-patient-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!isAuthReady || !psychologistId) {
            showMessage("Aguarde a autentica√ß√£o do Psic√≥logo.", 'error');
            return;
        }

        const patientIdInput = document.getElementById('patient-id-input');
        const patientId = patientIdInput.value.trim();
        const btn = document.getElementById('add-patient-btn');

        if (!patientId) {
            showMessage("Insira um ID de Paciente v√°lido.", 'error');
            return;
        }

        if (patientId === psychologistId) {
             showMessage("Voc√™ n√£o pode se adicionar como paciente!", 'error');
            return;
        }
        
        btn.textContent = 'Verificando...';
        btn.disabled = true;

        try {
            // 1. Verificar ID e role 'patient' (simula√ß√£o, pois o Firestore n√£o garante role)
            const patientUserDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', patientId);
            const patientSnap = await getDoc(patientUserDocRef);
            let patientNameFromData = `Paciente ${patientId.substring(0, 8)}`;


            if (!patientSnap.exists() || patientSnap.data().role !== 'patient') {
                showMessage(`ID ${patientId} n√£o encontrado ou n√£o √© um Paciente.`, 'error');
                return;
            }
            patientNameFromData = patientSnap.data().name || patientNameFromData;

            // 2. Salvar a associa√ß√£o na cole√ß√£o privada do psic√≥logo
            const patientsCollectionRef = collection(db, 'artifacts', appId, 'users', psychologistId, 'patients');
            
            await setDoc(doc(patientsCollectionRef, patientId), {
                patientId: patientId,
                name: patientNameFromData,
                addedAt: serverTimestamp(),
            });

            showMessage(`Paciente "${patientNameFromData}" associado com sucesso!`, 'success');
            patientIdInput.value = '';

        } catch (error) {
            console.error("Erro ao adicionar paciente:", error);
            showMessage(`Falha ao associar: ${error.message}`, 'error');
        } finally {
            btn.textContent = 'Adicionar Paciente';
            btn.disabled = false;
        }
    });

    function loadPatientList() {
        if (!isAuthReady || !psychologistId || !db) return;

        const patientsCollectionRef = collection(db, 'artifacts', appId, 'users', psychologistId, 'patients');
        const q = query(patientsCollectionRef);

        const loadingMessage = document.getElementById('loading-patients');
        loadingMessage.classList.remove('hidden');

        onSnapshot(q, (snapshot) => {
            const patients = [];
            snapshot.forEach(doc => {
                patients.push(doc.data());
            });

            renderPatientList(patients);
            loadingMessage.classList.add('hidden');
        }, (error) => {
            console.error("Erro ao ouvir lista de pacientes:", error);
            showMessage('Erro ao carregar a lista de pacientes.', 'error');
            loadingMessage.classList.add('hidden');
        });
    }

    function renderPatientList(patients) {
        const patientList = document.getElementById('patient-list');
        patientList.innerHTML = '';

        if (patients.length === 0) {
            patientList.innerHTML = '<p class="text-gray-500 text-center py-8">Voc√™ ainda n√£o tem pacientes associados.</p>';
            document.getElementById('patient-details-card').classList.add('hidden');
            document.getElementById('initial-message').classList.remove('hidden');
            return;
        }
        
        patients.forEach(patient => {
            const patientElement = document.createElement('div');
            patientElement.className = 'p-4 bg-white rounded-lg shadow-md hover:bg-indigo-50 cursor-pointer transition duration-150 border-l-4 border-indigo-400';
            patientElement.innerHTML = `
                <div class="font-bold text-gray-800">${patient.name}</div>
                <div class="text-xs text-gray-500 truncate mt-1">ID: ${patient.patientId}</div>
            `;
            
            patientElement.addEventListener('click', () => {
                // Remove destaque de todos
                document.querySelectorAll('#patient-list > div').forEach(el => el.classList.remove('bg-indigo-100', 'border-indigo-600'));
                
                // Define o paciente selecionado globalmente
                selectedPatientId = patient.patientId;
                selectedPatientName = patient.name;
                
                // Inicia a visualiza√ß√£o do di√°rio e metas
                viewPatientMood(selectedPatientId, selectedPatientName);
                viewPatientGoals(selectedPatientId); 

                // Destaca o paciente selecionado
                patientElement.classList.add('bg-indigo-100', 'border-indigo-600');
                document.getElementById('initial-message').classList.add('hidden');
            });

            patientList.appendChild(patientElement);
        });
        
        // Seleciona o primeiro paciente por padr√£o na inicializa√ß√£o
        if (patients.length > 0 && !selectedPatientId) {
            patientList.children[0].click(); 
        } else if (selectedPatientId) {
            // Se j√° havia um selecionado, re-seleciona
            const currentSelected = Array.from(patientList.children).find(el => el.querySelector('code')?.textContent.includes(selectedPatientId));
            if (currentSelected) {
                 currentSelected.classList.add('bg-indigo-100', 'border-indigo-600');
            } else {
                 // Se o paciente selecionado n√£o estiver mais na lista (foi removido), limpa a sele√ß√£o
                 document.getElementById('patient-details-card').classList.add('hidden');
                 selectedPatientId = null;
                 selectedPatientName = null;
            }
        }
    }

    // --- L√ìGICA DE VISUALIZA√á√ÉO DO DI√ÅRIO DE HUMOR DO PACIENTE ---

    function viewPatientMood(patientId, patientName) {
        if (!db) return;

        // Atualiza o cabe√ßalho do painel de detalhes
        document.getElementById('patient-details-card').classList.remove('hidden');
        document.getElementById('patient-name-detail').textContent = patientName;
        document.getElementById('patient-id-detail').textContent = patientId;
        
        const moodEntriesDetail = document.getElementById('mood-entries-detail');
        moodEntriesDetail.innerHTML = '<p class="text-center text-indigo-500 py-8">Carregando di√°rio de humor...</p>';
        document.getElementById('tab-mood').click(); // Define a aba Di√°rio como ativa

        // Caminho para a cole√ß√£o privada do *PACIENTE*: /artifacts/{appId}/users/{patientId}/mood_entries
        const patientMoodCollectionRef = collection(db, 'artifacts', appId, 'users', patientId, 'mood_entries');
        const q = query(patientMoodCollectionRef);

        onSnapshot(q, (snapshot) => {
            let entries = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                entries.push({ id: doc.id, ...data });
            });
            
            entries.sort((a, b) => {
                const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : (a.timestamp || 0);
                const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : (b.timestamp || 0);
                return timeB - timeA;
            });

            renderPatientMoodDetails(entries);

        }, (error) => {
            console.error("Erro ao ouvir di√°rio do paciente:", error);
            moodEntriesDetail.innerHTML = `<p class="text-center text-red-500 py-8">Erro ao carregar dados do paciente.</p>`;
        });
    }

    function renderPatientMoodDetails(entries) {
        const moodEntriesDetail = document.getElementById('mood-entries-detail');
        moodEntriesDetail.innerHTML = '';

        if (entries.length === 0) {
            moodEntriesDetail.innerHTML = '<p class="text-gray-500 text-center py-8">O paciente ainda n√£o registrou entradas no di√°rio.</p>';
            return;
        }

        entries.forEach(entry => {
            const mood = MOOD_MAP[entry.mood] || { emoji: '‚ùì', color: 'bg-gray-200 text-gray-800', text: 'Desconhecido' };
            const dateStr = formatDate(entry.timestamp);

            const entryElement = document.createElement('div');
            entryElement.className = 'bg-gray-50 p-4 rounded-lg shadow-sm mb-3 border border-gray-100';
            entryElement.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center space-x-3">
                        <span class="mood-indicator ${mood.color}">${mood.emoji}</span>
                        <span class="font-semibold text-lg text-gray-700">${mood.text}</span>
                    </div>
                    <span class="text-xs text-gray-500">${dateStr}</span>
                </div>
                <p class="text-sm text-gray-600 notes-content">${entry.notes || 'Sem notas.'}</p>
            `;
            moodEntriesDetail.appendChild(entryElement);
        });
    }

    // --- L√ìGICA DE CRIA√á√ÉO DE METAS ---
    
    // Abre o modal de cria√ß√£o de meta
    document.getElementById('open-goal-modal-btn').addEventListener('click', () => {
        if (!selectedPatientId) {
            showMessage("Selecione um paciente primeiro.", 'error');
            return;
        }
        document.getElementById('goal-patient-name').textContent = selectedPatientName;
        document.getElementById('goal-modal').classList.remove('hidden');
    });

    // Fecha o modal
    document.getElementById('close-goal-modal').addEventListener('click', () => {
        document.getElementById('goal-modal').classList.add('hidden');
        document.getElementById('goal-form').reset();
    });

    // Submete a cria√ß√£o da meta
    document.getElementById('goal-form').addEventListener('submit', async (e) => {
        e.preventDefault();

        if (!psychologistId || !selectedPatientId) {
            showMessage("Erro: Psic√≥logo ou Paciente n√£o selecionado.", 'error');
            return;
        }
        
        const title = document.getElementById('goal-title').value.trim();
        const description = document.getElementById('goal-description').value.trim();
        const btn = document.getElementById('save-goal-btn');

        if (!title || !description) {
            showMessage("Preencha o t√≠tulo e a descri√ß√£o da meta.", 'error');
            return;
        }
        
        btn.textContent = 'Salvando...';
        btn.disabled = true;

        try {
            // Cole√ß√£o p√∫blica para Metas: /artifacts/{appId}/public/data/goals
            const goalsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'goals');
            
            const goalData = {
                psychologistId: psychologistId,
                patientId: selectedPatientId,
                title: title,
                description: description,
                isCompleted: false, // O paciente que ir√° mudar isso
                createdAt: serverTimestamp(),
            };

            await addDoc(goalsCollectionRef, goalData);

            showMessage('Meta criada com sucesso!', 'success');
            document.getElementById('goal-modal').classList.add('hidden');
            document.getElementById('goal-form').reset();


        } catch (error) {
            console.error("Erro ao salvar meta:", error);
            showMessage(`Falha ao salvar meta: ${error.message}`, 'error');
        } finally {
            btn.textContent = 'Criar Meta';
            btn.disabled = false;
        }
    });
    
    // --- L√ìGICA DE VISUALIZA√á√ÉO DE METAS DO PACIENTE ---

    function viewPatientGoals(patientId) {
        if (!db) return;

        const goalList = document.getElementById('goal-entries-detail');
        goalList.innerHTML = '<p class="text-center text-indigo-500 py-8">Carregando metas...</p>';

        // Busca metas onde o patientId corresponde ao ID do paciente selecionado
        // Cole√ß√£o p√∫blica para Metas: /artifacts/{appId}/public/data/goals
        const goalsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'goals');
        const q = query(goalsCollectionRef, where('patientId', '==', patientId));

        onSnapshot(q, (snapshot) => {
            let goals = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                goals.push({ id: doc.id, ...data });
            });
            
            // Ordena localmente por status (n√£o conclu√≠da primeiro) e depois por data
            goals.sort((a, b) => {
                if (a.isCompleted !== b.isCompleted) {
                    return a.isCompleted ? 1 : -1; // Incompleta primeiro (false=0, true=1)
                }
                const timeA = a.createdAt?.toMillis ? a.createdAt.toMillis() : (a.createdAt || 0);
                const timeB = b.createdAt?.toMillis ? b.createdAt.toMillis() : (b.createdAt || 0);
                return timeB - timeA;
            });

            renderPatientGoals(goals);

        }, (error) => {
            console.error("Erro ao ouvir metas do paciente:", error);
            goalList.innerHTML = `<p class="text-center text-red-500 py-8">Erro ao carregar metas.</p>`;
        });
    }

    function renderPatientGoals(goals) {
        const goalList = document.getElementById('goal-entries-detail');
        goalList.innerHTML = '';

        if (goals.length === 0) {
            goalList.innerHTML = '<p class="text-gray-500 text-center py-8">Este paciente n√£o tem metas ativas.</p>';
            return;
        }

        goals.forEach(goal => {
            const statusClass = goal.isCompleted ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500';
            const statusText = goal.isCompleted ? 'Conclu√≠da' : 'Pendente';
            const checkIcon = goal.isCompleted ? '&#10003;' : '&#9899;'; // Checkmark / Dot

            const goalElement = document.createElement('div');
            goalElement.className = `p-4 rounded-xl shadow-md mb-4 border-l-4 ${statusClass} transition duration-200`;
            goalElement.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <h4 class="text-lg font-bold text-gray-800">${goal.title}</h4>
                    <span class="text-sm font-semibold p-1 px-3 rounded-full ${goal.isCompleted ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}">
                        ${checkIcon} ${statusText}
                    </span>
                </div>
                <p class="text-sm text-gray-700 mb-3">${goal.description}</p>
                <div class="text-xs text-gray-500">
                    Criada em: ${formatDate(goal.createdAt)}
                </div>
            `;
            goalList.appendChild(goalElement);
        });
    }

    // --- L√ìGICA DE ABA (TAB) ---
    window.showTab = function(tabName, clickedElement) {
        // Esconde todos os conte√∫dos
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.add('hidden');
        });

        // Mostra o conte√∫do da aba selecionada
        document.getElementById(tabName).classList.remove('hidden');

        // Remove a classe de ativo de todas as abas
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('border-indigo-600', 'text-indigo-600', 'font-semibold');
            btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        });

        // Adiciona a classe de ativo ao bot√£o clicado
        clickedElement.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
        clickedElement.classList.add('border-indigo-600', 'text-indigo-600', 'font-semibold');
    }

    // Inicializa a primeira aba
    document.addEventListener('DOMContentLoaded', () => {
        // A aba ser√° inicializada no onAuthStateChanged, mas garantimos o click aqui caso o user-id j√° esteja pronto
        if(isAuthReady) {
            document.getElementById('tab-mood').click();
        }
    });

</script>

<!-- Layout Principal -->
<div class="min-h-screen flex">
    
    <!-- Painel Lateral de Pacientes -->
    <aside class="w-80 bg-white p-6 shadow-2xl flex flex-col">
        <h2 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-3">Seus Pacientes</h2>
        
        <!-- ID do Psic√≥logo para Compartilhamento -->
        <div class="mb-6 p-3 bg-gray-100 rounded-lg">
            <label class="block text-xs font-semibold text-gray-600 mb-1">Seu ID de Psic√≥logo (Compartilhe!)</label>
            <code id="psychologist-id" class="text-xs text-gray-800 break-all cursor-copy" title="Clique para copiar ID">Carregando...</code>
        </div>
        
        <!-- Formul√°rio de Adicionar Paciente -->
        <form id="add-patient-form" class="mb-6 p-4 bg-indigo-50 rounded-lg shadow-inner">
            <h3 class="text-md font-semibold text-indigo-800 mb-3">Adicionar Paciente por ID</h3>
            <input type="text" id="patient-id-input" placeholder="Cole o ID do Paciente aqui" class="w-full p-2 border border-indigo-300 rounded-lg text-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 mb-3" required>
            <button type="submit" id="add-patient-btn" class="w-full py-2 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition duration-300">
                Adicionar Paciente
            </button>
        </form>

        <!-- Lista de Pacientes -->
        <div class="flex-grow overflow-y-auto space-y-3">
            <div id="loading-patients" class="text-center py-4 text-gray-500">Carregando lista...</div>
            <div id="patient-list">
                <!-- Pacientes ser√£o injetados aqui -->
            </div>
        </div>
    </aside>

    <!-- √Årea Principal de Detalhes -->
    <main class="flex-grow p-10 overflow-y-auto">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-8">An√°lise de Progresso</h1>
        
        <!-- Card de Detalhes do Paciente Selecionado -->
        <div id="patient-details-card" class="bg-white p-8 rounded-2xl shadow-xl hidden">
            
            <header class="mb-6 border-b pb-4 flex justify-between items-start">
                <div>
                    <h2 class="text-3xl font-bold text-indigo-600 mb-1">
                        <span id="patient-name-detail" class="font-extrabold"></span>
                    </h2>
                    <p class="text-sm text-gray-500">ID: <code id="patient-id-detail"></code></p>
                </div>
                <button id="open-goal-modal-btn" class="py-2 px-4 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition duration-300 shadow-md">
                    + Nova Meta
                </button>
            </header>
            
            <!-- Abas de Navega√ß√£o -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button id="tab-mood" onclick="showTab('mood-entries-detail', this)" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-semibold text-sm text-indigo-600 border-indigo-600">
                        Di√°rio de Humor
                    </button>
                    <button id="tab-goals" onclick="showTab('goal-entries-detail', this)" class="tab-button whitespace-nowrap py-3 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                        Metas/Tarefas
                    </button>
                </nav>
            </div>


            <!-- Conte√∫do da Aba 1: Di√°rio de Humor -->
            <div id="mood-entries-detail" class="tab-content space-y-4 max-h-[500px] overflow-y-auto">
                <!-- Entradas do di√°rio ser√£o injetadas aqui -->
            </div>

            <!-- Conte√∫do da Aba 2: Metas/Tarefas -->
            <div id="goal-entries-detail" class="tab-content space-y-4 max-h-[500px] overflow-y-auto hidden">
                <!-- Metas ser√£o injetadas aqui -->
            </div>
            
        </div>
        
        <p id="initial-message" class="text-center text-gray-500 py-20 text-lg">
            Selecione um paciente na lista lateral para visualizar seu di√°rio de humor e definir metas.
        </p>
    </main>
</div>

<!-- Modal de Cria√ß√£o de Meta (Hidden por padr√£o) -->
<div id="goal-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
            <h3 class="text-xl font-bold text-indigo-700">Definir Nova Meta</h3>
            <button id="close-goal-modal" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
        </div>
        
        <p class="mb-4 text-sm text-gray-600">
            Criando meta para: <span id="goal-patient-name" class="font-semibold text-indigo-600"></span>
        </p>

        <form id="goal-form">
            <div class="mb-4">
                <label for="goal-title" class="block text-sm font-medium text-gray-700 mb-1">T√≠tulo da Meta (Ex: Dar uma volta)</label>
                <input type="text" id="goal-title" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
            </div>
            <div class="mb-6">
                <label for="goal-description" class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o Detalhada/Instru√ß√µes</label>
                <textarea id="goal-description" rows="3" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150" placeholder="O que exatamente o paciente deve fazer."></textarea>
            </div>
            
            <button type="submit" id="save-goal-btn" class="w-full py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-300">
                Criar Meta
            </button>
        </form>
    </div>
</div>

<!-- Notifica√ß√£o de Status (Toast) -->
<div id="notification-box" class="hidden"></div>

<script type="text/javascript">
    // Script para copiar o ID do psic√≥logo ao clicar
    document.addEventListener('DOMContentLoaded', () => {
        const psychologistIdElement = document.getElementById('psychologist-id');
        if (psychologistIdElement) {
            psychologistIdElement.addEventListener('click', () => {
                const idToCopy = psychologistIdElement.textContent;
                if (idToCopy && idToCopy !== 'Carregando...' && idToCopy !== 'N√£o autenticado.') {
                    // Usa execCommand('copy') pois navigator.clipboard pode n√£o funcionar no iFrame
                    const tempInput = document.createElement('textarea');
                    tempInput.value = idToCopy;
                    document.body.appendChild(tempInput);
                    tempInput.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempInput);
                    showMessage('ID copiado para a √°rea de transfer√™ncia!', 'info');
                }
            });
        }
    });
</script>

</body>
</html>
