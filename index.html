<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Paciente - PsicoConnect</title>
    <!-- Carrega o Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            min-height: 100vh;
        }
    </style>
</head>
<body>

<!-- Configuração e Importações do Firebase -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, setDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variáveis Globais do Ambiente (Obrigatórias)
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    setLogLevel('Debug');
    
    let app, db, auth;
    let userId = null;
    let isAuthReady = false;

    // Inicialização do Firebase
    try {
        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Função para autenticar
            async function authenticate() {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Erro na autenticação inicial:", error);
                    showMessage(`Falha na autenticação inicial. Recarregue a página.`, 'error');
                }
            }

            // Listener de estado de autenticação
            onAuthStateChanged(auth, (user) => {
                isAuthReady = true;
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-uid').textContent = userId;
                    // Inicia o carregamento dos dados após a autenticação
                    loadPatientData();
                    loadTasks();
                } else {
                    userId = null;
                    document.getElementById('user-uid').textContent = 'N/A';
                    showMessage('Sessão encerrada. Faça login novamente.', 'info');
                }
            });

            authenticate();

        } else {
            console.error("Configuração do Firebase vazia.");
            showMessage('Erro: Firebase não configurado. Dados não serão carregados.', 'error');
        }
    } catch (e) {
        console.error("Erro ao inicializar o Firebase:", e);
        showMessage('Erro: Falha ao iniciar o aplicativo.', 'error');
    }

    // --- FUNÇÕES DE LÓGICA DO DASHBOARD ---

    /**
     * Função para exibir mensagens.
     * @param {string} message - A mensagem a ser exibida.
     * @param {string} type - 'success', 'error', 'info'.
     */
    function showMessage(message, type = 'info') {
        const box = document.getElementById('notification-box');
        box.textContent = message;
        box.className = 'absolute top-4 right-4 p-3 rounded-lg text-sm transition-opacity duration-300';
        
        if (type === 'error') {
            box.classList.add('bg-red-500', 'text-white');
        } else if (type === 'success') {
            box.classList.add('bg-green-500', 'text-white');
        } else {
            box.classList.add('bg-blue-500', 'text-white');
        }
        
        box.classList.remove('hidden');
        setTimeout(() => {
            box.classList.add('hidden');
        }, 5000);
    }

    /**
     * Carrega dados do paciente e próxima sessão (SIMULADO).
     */
    function loadPatientData() {
        if (!isAuthReady || !userId) return;

        // Simulando a busca por dados do paciente logado
        const patientNameEl = document.getElementById('patient-name');
        patientNameEl.textContent = "Olá, Paciente Exemplo!"; // Nome do paciente seria carregado aqui.

        // Simulação de Próxima Sessão
        const nextSessionEl = document.getElementById('next-session');
        const sessionDate = new Date();
        sessionDate.setDate(sessionDate.getDate() + 3); // Próxima sessão em 3 dias
        
        nextSessionEl.innerHTML = `
            <div class="text-3xl font-bold text-indigo-700">${sessionDate.toLocaleDateString('pt-BR', { weekday: 'short', month: 'numeric', day: 'numeric' })}</div>
            <div class="text-xl font-semibold text-gray-800">${sessionDate.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</div>
        `;
    }

    /**
     * Carrega e monitora as tarefas/atividades do paciente (DADOS PRIVADOS).
     */
    function loadTasks() {
        // Interrompe se a autenticação não estiver pronta ou userId não estiver disponível
        if (!isAuthReady || !userId || !db) return;

        console.log(`Buscando tarefas para o paciente: ${userId}`);
        
        // Caminho da Coleção para dados PRIVADOS do paciente
        // /artifacts/{appId}/users/{userId}/tasks
        const tasksRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
        
        // Sem a função 'where', já que estamos na coleção privada do usuário
        const q = query(tasksRef);

        const tasksListEl = document.getElementById('tasks-list');
        tasksListEl.innerHTML = '<p class="text-center text-gray-500 mt-4">Carregando atividades...</p>';

        // Monitora em tempo real a coleção
        onSnapshot(q, (snapshot) => {
            const tasks = [];
            snapshot.forEach((doc) => {
                const data = doc.data();
                tasks.push({ id: doc.id, ...data });
            });

            renderTasks(tasks.sort((a, b) => a.isCompleted - b.isCompleted || a.createdAt - b.createdAt));
        }, (error) => {
            console.error("Erro ao carregar tarefas:", error);
            showMessage("Erro ao carregar a lista de atividades.", 'error');
            tasksListEl.innerHTML = '<p class="text-center text-red-500 mt-4">Falha ao carregar dados.</p>';
        });
    }

    /**
     * Renderiza a lista de tarefas/atividades na interface.
     * @param {Array<Object>} tasks - Lista de objetos de tarefas.
     */
    function renderTasks(tasks) {
        const tasksListEl = document.getElementById('tasks-list');
        tasksListEl.innerHTML = ''; 

        if (tasks.length === 0) {
            tasksListEl.innerHTML = '<p class="text-center text-gray-500 mt-4">Nenhuma atividade pendente. Que ótimo!</p>';
            // Adiciona uma tarefa de exemplo se for o primeiro acesso, para fins de demonstração
            if (isAuthReady && userId) {
                 addInitialTask();
            }
            return;
        }

        tasks.forEach(task => {
            const isChecked = task.isCompleted ? 'checked' : '';
            const textStyle = task.isCompleted ? 'line-through text-gray-400' : 'text-gray-800';
            
            const item = document.createElement('div');
            item.className = 'flex items-center justify-between p-4 mb-2 bg-white rounded-xl shadow-sm border border-gray-100 transition duration-150 hover:shadow-md';
            item.innerHTML = `
                <div class="flex items-center flex-1 min-w-0">
                    <input type="checkbox" id="task-${task.id}" ${isChecked} onchange="toggleTask('${task.id}', event.target.checked)" 
                           class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer">
                    <label for="task-${task.id}" class="ml-4 text-base font-medium ${textStyle} break-words cursor-pointer">
                        ${task.description}
                    </label>
                </div>
                <span class="text-xs text-gray-500 ml-4">${task.isCompleted ? 'Concluída' : 'Pendente'}</span>
            `;
            tasksListEl.appendChild(item);
        });
    }

    /**
     * Alterna o estado de conclusão de uma tarefa.
     * @param {string} taskId - ID do documento da tarefa.
     * @param {boolean} isCompleted - Novo estado de conclusão.
     */
    window.toggleTask = async function(taskId, isCompleted) {
        if (!userId || !db) {
            showMessage("Erro de autenticação/Firebase. Tente novamente.", 'error');
            return;
        }

        try {
            const taskDocRef = doc(db, 'artifacts', appId, 'users', userId, 'tasks', taskId);
            await updateDoc(taskDocRef, {
                isCompleted: isCompleted,
                completedAt: isCompleted ? Date.now() : null
            });

            showMessage(isCompleted ? "Atividade marcada como concluída!" : "Atividade reaberta.", 'success');
        } catch (error) {
            console.error("Erro ao atualizar tarefa:", error);
            showMessage(`Falha ao atualizar a atividade.`, 'error');
        }
    }

    /**
     * Função para adicionar uma tarefa inicial de demonstração.
     */
    async function addInitialTask() {
        if (!userId || !db) return;
        
        try {
            const tasksRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            const initialTask = {
                description: 'Escreva 3 coisas pelas quais você é grato(a) hoje.',
                isCompleted: false,
                createdAt: Date.now(),
            };
            // Usando setDoc com doc() sem ID para gerar um ID automático
            await setDoc(doc(tasksRef), initialTask); 
            console.log("Tarefa inicial de demonstração adicionada.");
        } catch (error) {
            console.error("Erro ao adicionar tarefa inicial:", error);
        }
    }

</script>

<!-- Conteúdo Principal -->
<div class="flex flex-col p-4 sm:p-6 lg:p-8">
    <header class="mb-8">
        <div class="flex justify-between items-center">
            <h1 id="patient-name" class="text-4xl font-extrabold text-gray-900">Olá!</h1>
            <div class="text-right">
                <p class="text-sm font-semibold text-gray-500">ID da Sessão:</p>
                <p id="user-uid" class="text-xs text-gray-400 truncate w-32 sm:w-auto">N/A</p>
            </div>
        </div>
        <p class="text-lg text-indigo-600 mt-1">Seu espaço para crescimento e cuidado.</p>
    </header>

    <!-- Resumos (Próxima Sessão e Mensagens) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        
        <!-- Próxima Sessão -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 flex justify-between items-center">
            <div>
                <p class="text-sm font-medium text-gray-500 mb-2">Sua Próxima Sessão</p>
                <div id="next-session" class="flex flex-col">
                    <!-- Data e hora serão preenchidas pelo JS -->
                    <div class="text-3xl font-bold text-indigo-700">--/--</div>
                    <div class="text-xl font-semibold text-gray-800">--:--</div>
                </div>
            </div>
            <button class="text-indigo-600 hover:text-indigo-800 p-2 rounded-full bg-indigo-100 transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101M20.121 9.929a4 4 0 00-5.656-5.656l-4 4a4 4 0 105.656 5.656l1.102-1.101M20 14h-4l-3 3-4-4"></path></svg>
            </button>
        </div>

        <!-- Mensagens/Lembretes -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
            <p class="text-sm font-medium text-gray-500 mb-2">Mensagens Recentes</p>
            <p class="text-lg font-semibold text-gray-800">Lembrete: Mande seu Diário da Semana.</p>
            <p class="text-sm text-yellow-600 mt-2">Enviado pela Dra. Ana, ontem às 10:30.</p>
        </div>

        <!-- Área de Recursos -->
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
            <p class="text-sm font-medium text-gray-500 mb-2">Seu Psicólogo</p>
            <p class="text-lg font-semibold text-gray-800">Dr(a). Ana Silva</p>
            <p class="text-sm text-green-600 mt-2">Clique para ver contatos e biografia.</p>
        </div>
    </div>

    <!-- Seção de Atividades/Tarefas -->
    <div class="bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Minhas Atividades & Tarefas</h2>
        
        <!-- Lista de Tarefas (Preenchida pelo JS) -->
        <div id="tasks-list" class="space-y-4">
            <!-- Itens de tarefas serão injetados aqui -->
        </div>
    </div>

</div>

<!-- Notificação de Status (Toast) -->
<div id="notification-box" class="hidden"></div>

</body>
</html>
