<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clínica Digital - Gerenciamento Psicológico</title>
    <!-- Incluindo Tailwind CSS para estilização (Em Produção, use o método CLI!) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --secondary-color: #fca5a5; /* Red 300 */
            --text-color: #1f2937; /* Gray 800 */
            --bg-color: #f9fafb; /* Gray 50 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        /* Estilos personalizados para botões e cards */
        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4f46e5; /* Indigo 600 */
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-radius: 0.75rem;
        }
        .loading-spinner {
            border-top-color: var(--primary-color);
            -webkit-animation: spinner 1s linear infinite;
            animation: spinner 1s linear infinite;
        }
        @keyframes spinner {
            to {transform: rotate(360deg);}
        }
        /* Estilos para o modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            max-width: 90%;
            width: 400px;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Modal para mensagens/erros -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content card p-6">
            <h3 id="modalTitle" class="text-xl font-bold mb-4 text-center"></h3>
            <p id="modalMessage" class="mb-6 text-center"></p>
            <button onclick="hideModal()" class="w-full btn-primary text-white py-2 px-4 rounded-lg font-semibold">Entendido</button>
        </div>
    </div>

    <!-- Container Principal do Aplicativo -->
    <div id="app-container" class="w-full max-w-md bg-white card p-8 transition-all duration-300">
        <!-- O conteúdo será carregado aqui (Login/Registro ou Dashboard) -->
    </div>

    <!-- Scripts do Firebase e Lógica do App -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configurações e Variáveis Globais
        // O Canvas fornece automaticamente estas variáveis para conexão com o Firestore.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let currentUserId = null;
        let isAuthenticated = false;

        // Ativa o log de debug do Firestore
        setLogLevel('Debug');

        // --- Funções de UI (Modal) ---
        window.showModal = function(title, message) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').style.display = 'flex';
        }

        window.hideModal = function() {
            document.getElementById('messageModal').style.display = 'none';
        }

        // --- Funções de Navegação e Renderização ---

        function renderLoginPage(errorMessage = null) {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Clínica Digital</h1>
                <p class="text-center text-sm text-gray-500 mb-8">Gerenciamento simplificado para Psicólogos.</p>

                ${errorMessage ? `<div class="p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">${errorMessage}</div>` : ''}

                <form id="loginForm" class="space-y-4">
                    <div class="space-y-2">
                        <label for="email" class="text-sm font-medium block text-gray-700">Email</label>
                        <input type="email" id="email" name="email" required placeholder="seu.email@exemplo.com"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="space-y-2">
                        <label for="password" class="text-sm font-medium block text-gray-700">Senha</label>
                        <input type="password" id="password" name="password" required placeholder="••••••••"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white py-3 mt-4 rounded-lg font-bold">
                        Entrar
                    </button>
                    <button type="button" onclick="renderRegisterPage()" class="w-full text-indigo-600 hover:text-indigo-800 text-sm mt-3 font-semibold p-2">
                        Não tem conta? Cadastre-se
                    </button>
                </form>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderRegisterPage() {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <h1 class="text-3xl font-extrabold text-center text-gray-800 mb-6">Novo Cadastro</h1>
                <p class="text-center text-sm text-gray-500 mb-8">Crie sua conta de Psicólogo(a).</p>

                <form id="registerForm" class="space-y-4">
                    <div class="space-y-2">
                        <label for="name" class="text-sm font-medium block text-gray-700">Nome Completo</label>
                        <input type="text" id="name" name="name" required placeholder="Seu Nome"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="space-y-2">
                        <label for="crp" class="text-sm font-medium block text-gray-700">CRP</label>
                        <input type="text" id="crp" name="crp" required placeholder="00/00000"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="space-y-2">
                        <label for="email" class="text-sm font-medium block text-gray-700">Email</label>
                        <input type="email" id="email" name="email" required placeholder="seu.email@exemplo.com"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div class="space-y-2">
                        <label for="password" class="text-sm font-medium block text-gray-700">Senha (mín. 6 caracteres)</label>
                        <input type="password" id="password" name="password" required placeholder="••••••••" minlength="6"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button type="submit" class="w-full btn-primary text-white py-3 mt-4 rounded-lg font-bold">
                        Cadastrar
                    </button>
                    <button type="button" onclick="renderLoginPage()" class="w-full text-indigo-600 hover:text-indigo-800 text-sm mt-3 font-semibold p-2">
                        Já tenho conta? Voltar ao Login
                    </button>
                </form>
            `;
            document.getElementById('registerForm').addEventListener('submit', handleRegister);
        }

        function renderDashboard(userData) {
            const container = document.getElementById('app-container');
            container.classList.remove('max-w-md');
            container.classList.add('max-w-4xl'); // Maior para o dashboard
            container.innerHTML = `
                <div class="flex justify-between items-center mb-8 pb-4 border-b">
                    <h1 class="text-2xl font-bold text-indigo-600">Bem-vindo(a), ${userData.name.split(' ')[0]}</h1>
                    <button onclick="window.signOutUser()" class="text-sm text-red-500 hover:text-red-700 font-semibold p-2 rounded-lg border border-red-300 transition duration-150">
                        Sair
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card 1: Informações do Perfil -->
                    <div class="card p-6 bg-indigo-50 border border-indigo-200">
                        <h2 class="text-xl font-semibold mb-3 text-indigo-700">Meu Perfil</h2>
                        <p class="text-gray-700"><strong>Nome:</strong> ${userData.name}</p>
                        <p class="text-gray-700"><strong>Email:</strong> ${userData.email}</p>
                        <p class="text-gray-700"><strong>CRP:</strong> ${userData.crp}</p>
                        <p class="text-gray-700 mt-2 text-xs">ID de Usuário (UID): ${currentUserId}</p>
                    </div>

                    <!-- Card 2: Clientes -->
                    <div class="card p-6 bg-white border border-gray-200 col-span-1 md:col-span-2">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800">Meus Clientes (Em Desenvolvimento)</h2>
                        <p class="text-gray-600">Esta seção será usada para gerenciar seus pacientes e sessões.</p>
                        <button class="btn-primary text-white py-2 px-4 rounded-lg mt-4 text-sm font-medium">
                            Adicionar Novo Cliente
                        </button>
                    </div>
                </div>
            `;
        }

        // --- Funções do Firebase (Auth e Firestore) ---

        /**
         * Inicializa o Firebase e tenta autenticar.
         */
        async function initializeAppAndAuth() {
            const container = document.getElementById('app-container');
            container.innerHTML = `<div class="flex justify-center items-center h-40">
                <div class="loading-spinner w-8 h-8 border-4 border-solid border-white rounded-full"></div>
                <span class="ml-3 text-gray-600">Carregando aplicação...</span>
            </div>`;

            if (!firebaseConfig) {
                console.error("ERRO: Configuração do Firebase vazia. Não é possível conectar ao banco de dados. Entrando em Modo de Simulação (Mock Mode).");
                showModal("ERRO DE CONFIGURAÇÃO", "A configuração do Firebase está ausente. O aplicativo entrará no Modo de Simulação (Mock Mode), e os dados não serão salvos permanentemente.");
                // Em modo de simulação, apenas renderiza a página de login
                renderLoginPage();
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticação Inicial com token customizado ou anonimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Autenticação com token customizado bem-sucedida.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Autenticação anônima bem-sucedida.");
                }

                // O Observador de estado de autenticação lida com o redirecionamento pós-login/registro
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isAuthenticated = true;
                        // Tenta carregar dados do usuário logado
                        await loadPsychologistData(user.uid);
                    } else {
                        currentUserId = null;
                        isAuthenticated = false;
                        renderLoginPage();
                    }
                });

            } catch (error) {
                console.error("Erro na inicialização ou autenticação do Firebase:", error);
                showModal("ERRO FATAL", `Não foi possível inicializar o aplicativo. Detalhes: ${error.message}`);
                renderLoginPage(`Erro ao iniciar: ${error.message}`);
            }
        }

        /**
         * Lida com o processo de registro de um novo psicólogo.
         */
        async function handleRegister(event) {
            event.preventDefault();

            const form = event.target;
            const name = form.name.value;
            const crp = form.crp.value;
            const email = form.email.value;
            const password = form.password.value;

            // Se estiver em mock mode, apenas mostra o sucesso e sai.
            if (!isAuthenticated && !db) {
                console.warn("[MOCK MODE] Simulação de registro de psychologist bem-sucedida.");
                showModal("Sucesso (Simulação)", `O registro de ${name} foi simulado. No modo real, você seria logado.`);
                renderLoginPage();
                return;
            }

            try {
                // 1. Cria o usuário no Firebase Authentication
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userId = user.uid;

                // 2. Cria o documento do psicólogo no Firestore (Coleção privada)
                const psychologistData = {
                    name: name,
                    crp: crp,
                    email: email, // Armazenar o email também para consultas
                    role: 'psychologist',
                    createdAt: new Date().toISOString()
                };

                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);

                // Usa setDoc para criar ou sobrescrever o documento de perfil
                await setDoc(userDocRef, psychologistData);

                console.log("Registro e salvamento do perfil do psicólogo no Firestore bem-sucedidos.", userId);
                // O onAuthStateChanged (observador de estado) será acionado e chamará loadPsychologistData
                // Não precisa de redirecionamento manual.

            } catch (error) {
                let errorMessage = "Ocorreu um erro no registro.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Este email já está em uso. Tente fazer login ou use outro email.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "A senha deve ter pelo menos 6 caracteres.";
                } else {
                    errorMessage = error.message;
                }
                console.error("Erro ao registrar usuário:", error);
                showModal("Falha no Registro", errorMessage);
            }
        }

        /**
         * Lida com o processo de login de um usuário existente (não implementado neste momento,
         * mas necessário para um app real).
         */
        function handleLogin(event) {
             event.preventDefault();
             showModal("Login em Construção", "O login com email/senha ainda não foi implementado. Por favor, registre uma nova conta (o registro funciona com email/senha).");
        }


        /**
         * Carrega os dados do perfil do psicólogo logado.
         */
        async function loadPsychologistData(userId) {
            // Caminho para o documento de perfil privado: artifacts/{appId}/users/{userId}/profile/data
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile/data`);

            try {
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    console.log("Dados do psicólogo carregados:", userData);
                    renderDashboard(userData);
                } else {
                    console.warn("Nenhum dado de perfil encontrado para o usuário. Redirecionando para o login.");
                    // Isso pode acontecer se o usuário foi criado, mas o documento de perfil falhou.
                    // Em um app real, você pediria para o usuário completar o perfil. Por agora, apenas desloga.
                    await signOut(auth);
                }

            } catch (error) {
                console.error("Erro ao carregar dados do psicólogo:", error);
                showModal("Erro de Dados", `Não foi possível carregar seu perfil. ${error.message}`);
                // Desloga em caso de erro grave.
                await signOut(auth);
            }
        }


        /**
         * Funções de Logout para a janela (acessível via botão)
         */
        window.signOutUser = async function() {
            if (!isAuthenticated && !db) {
                 console.warn("[MOCK MODE] Simulação de logout. Redirecionando para a seleção de perfil.");
                 showModal("Logout (Simulação)", "Você foi desconectado no modo de simulação.");
                 renderLoginPage();
                 return;
            }

            try {
                await signOut(auth);
                console.log("Logout bem-sucedido.");
                // O onAuthStateChanged cuidará da renderização da página de login.
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                showModal("Falha no Logout", `Não foi possível fazer logout. ${error.message}`);
            }
        }


        // Inicia o aplicativo ao carregar a página
        window.onload = initializeAppAndAuth;

    </script>
</body>
</html>
